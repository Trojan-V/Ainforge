name: Modrinth release -> Discord (embed)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      # not needed for PAT-based API calls, but harmless:
      contents: read

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch latest Modrinth version (ainforge)
        id: modrinth
        run: |
          json=$(curl -fsSL "https://api.modrinth.com/v2/project/ainforge/version")
          id=$(echo "$json" | jq -r '.[0].id')
          name=$(echo "$json" | jq -r '.[0].name')

          ver_raw=$(echo "$json" | jq -r '.[0].version_number')
          ver=${ver_raw#v}   # remove optional leading "v"

          date=$(echo "$json" | jq -r '.[0].date_published')
          downloads=$(echo "$json" | jq -r '.[0].downloads')

          echo "id=$id" >> "$GITHUB_OUTPUT"
          echo "name=$name" >> "$GITHUB_OUTPUT"
          echo "ver=$ver" >> "$GITHUB_OUTPUT"
          echo "date=$date" >> "$GITHUB_OUTPUT"
          echo "downloads=$downloads" >> "$GITHUB_OUTPUT"

      - name: Compare with last notified version (repo variable)
        id: compare
        env:
          LAST: ${{ vars.MODRINTH_LAST_VERSION_ID }}
          CURR: ${{ steps.modrinth.outputs.id }}
        run: |
          if [ "$CURR" = "$LAST" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Send Discord embed (ping modpack-updates)
        if: steps.compare.outputs.changed == 'true'
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ROLE_ID: "1451591252607893614"
          VERSION: ${{ steps.modrinth.outputs.ver }}
          NAME: ${{ steps.modrinth.outputs.name }}
          DATE: ${{ steps.modrinth.outputs.date }}
          DOWNLOADS: ${{ steps.modrinth.outputs.downloads }}
        run: |
          payload=$(jq -n \
            --arg role "<@&$ROLE_ID>" \
            --arg roleId "$ROLE_ID" \
            --arg title "New Ainforge release: $VERSION" \
            --arg url "https://modrinth.com/modpack/ainforge" \
            --arg desc "$NAME" \
            --arg timestamp "$DATE" \
            --arg v "$VERSION" \
            --arg d "$DOWNLOADS" \
            '{
              content: $role,
              allowed_mentions: { roles: [$roleId] },
              username: "Ainforge Release Bot",
              embeds: [
                {
                  title: $title,
                  url: $url,
                  description: $desc,
                  color: 3447003,
                  timestamp: $timestamp,
                  fields: [
                    { name: "Version", value: $v, inline: true },
                    { name: "Downloads", value: $d, inline: true }
                  ],
                  footer: { text: "Modrinth" }
                }
              ]
            }')

          curl -fsSL -H "Content-Type: application/json" -d "$payload" "$WEBHOOK"

      - name: Update repo variable MODRINTH_LAST_VERSION_ID (via PAT)
        if: steps.compare.outputs.changed == 'true'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          VALUE: ${{ steps.modrinth.outputs.id }}
        run: |
          api="https://api.github.com/repos/$OWNER/$REPO/actions/variables/MODRINTH_LAST_VERSION_ID"

          curl -fsSL -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_PAT" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "$(jq -n --arg value "$VALUE" '{value:$value}')" \
            "$api"
